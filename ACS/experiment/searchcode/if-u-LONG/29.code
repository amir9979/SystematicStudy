long em = EM;
if (e < curr) {
long x = Math.min(em, curr - e);
e += x;
em -= x;
}
long m = M;
if (m < curr) {
long x = Math.min(em, curr - m);

