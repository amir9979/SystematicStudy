double T = 1 + mat.m00 + mat.m11 + mat.m22;
if( T > 0.00000001 ) //to avoid large distortions!
{
double S = Math.sqrt(T) * 2;
// dot product of q1 and this is negative. Second case was not needed.

double dot,s1,s2,om,sinom;

dot = q2.x*q1.x + q2.y*q1.y + q2.z*q1.z + q2.w*q1.w;

if ( dot < 0 ) {

